

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Quaternion UKF &mdash; QuaternionUkf 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="estimator" href="modules.html" />
    <link rel="prev" title="Welcome to QuaternionUkf’s documentation!" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> QuaternionUkf
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Quaternion UKF</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#project-setup">Project Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementation-details">Implementation Details</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sensor-data-processing">Sensor data processing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">estimator</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">QuaternionUkf</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Quaternion UKF</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/includeme.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="quaternion-ukf">
<h1>Quaternion UKF<a class="headerlink" href="#quaternion-ukf" title="Permalink to this headline">¶</a></h1>
<p>Implentation of an unscented Kalman filter for orientation tracking of a robot (e.g. a quadrotor or drone).</p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This implementation of a UKF for tracking orientation of a drone with gyro and accelerometer data follows closely that described in the paper “A Quaternion-based Unscented Kalman Filter for Orientation Tracking” by Edgar Kraft.</p>
<p>This project was completed as part of ESE 650: Learning in Robotics at the University of Pennsylvania, though it has been tweaked, and additional infrastructure has been built since then. This additional infrastructure includes a means to manufacture toy data to validate that the filter is indeed working properly.</p>
</div>
<div class="section" id="project-setup">
<h2>Project Setup<a class="headerlink" href="#project-setup" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Clone repository</p></li>
</ul>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>git clone https://github.com/mattlisle/quaternion-ukf.git
</pre></div>
</td></tr></table></div>
<ul class="simple">
<li><p>Create a virtual environment and run setup script (python version should be &gt;= 3.6)</p></li>
</ul>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">virtualenv</span> <span class="o">--</span><span class="n">python</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">new</span><span class="o">/</span><span class="n">virtualenv</span>
<span class="n">source</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">new</span><span class="o">/</span><span class="n">virtualenv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="n">make</span> <span class="n">install</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>There are three sample datasets to run the code on. To run in terminal:</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>make run <span class="nv">DATASET</span><span class="o">=</span>&lt;n&gt;
</pre></div>
</td></tr></table></div>
<p>Where <code class="code docutils literal notranslate"><span class="pre">&lt;n&gt;</span></code> is a number from 1 to 3.</p>
</div>
<div class="section" id="implementation-details">
<h2>Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<p>As mentioned above, the implementation follows the example in the paper fairly closely. The goal is to fuse accelerometer and gyro data to get the best possible estimate of orientation, in terms of roll, pitch, and yaw.</p>
<div class="section" id="sensor-data-processing">
<h3>Sensor data processing<a class="headerlink" href="#sensor-data-processing" title="Permalink to this headline">¶</a></h3>
<p>The first step in this process is to convert the IMU data from some digital reading to the corresponding value with the correct units. These sensors are manufactured to be fairly linear in the range in which the drone operates, so a linear regression model is a reasonable fit for calibrating the data, which leads to the following equation:</p>
<div class="math notranslate nohighlight">
\[\boldsymbol{\beta} = \left(\textbf{A}^{\top}\textbf{A}\right)^{-1}\textbf{A}^{\top}\textbf{y}\]</div>
<p>Where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\boldsymbol{\beta}\)</span> represents a vector made of essentially the slope and intercept for fitting the IMU data (which is what we want).</p></li>
<li><p><strong>A</strong> has two columns, the first is one dimension of the IMU data, e.g. the accelerometer’s x-component</p></li>
<li><p><strong>y</strong> is the ground truth, which we don’t quite have yet}</p></li>
</ul>
<p>Okay, so we’ve got the equation, (which numpy implements for us with <code class="code docutils literal notranslate"><span class="pre">np.linalg.lstsq</span></code> ), but there’s still the unknown of how to get the ground truth data to fit the IMU data to. That’s where the vicon data comes in, which is a time series of rotation matrices over approximately the same timespan as the IMU data. Getting the expected accelerometer data is quite straightforward because the accelerometer is a measurement of the acceleration felt along the robot’s z-axis. In equation form:</p>
<div class="math notranslate nohighlight">
\[\hat{\textbf{g}}^r = \textbf{R}_w^r \hat{\textbf{g}}^w\]</div>
<p>Gravity in the world frame is just the world frame’s z-axis, and the vicon rotations define the rotation between the world and robot frames. However, solving for the rotational velocity is a bit trickier. If we assume that the angular velocity is constant, then we can say the following:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\dot{\textbf{R}} &amp;= \textbf{S}(\boldsymbol{\omega})\textbf{R} \\
\textbf{R}(t) &amp;= \exp \Big( \textbf{S}(\boldsymbol{\omega}) \Delta t \Big) \textbf{R}_0 \\
\textbf{R}_1 \textbf{R}_0^{\top} &amp;= \exp \Big( \textbf{S}(\boldsymbol{\omega}) \Delta t \Big) = R\end{split}\]</div>
<p>The left side of that equation represents the rotation in a given timestep, which can be represented by an axis and an angle:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\theta &amp;= \cos^{-1} \left( \frac{\text{Tr}(R) - 1}{2} \right) \\
\textbf{S}(\textbf{u}) &amp;= \frac{1}{2 \sin \theta} \left( R - R^{\top} \right)\end{split}\]</div>
<p>We can also convert from axis angle directly to angular velocity, which leads us to a solution we can actually use:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\boldsymbol{\omega} &amp;= \frac{\theta}{\Delta t} \textbf{u} \\
\textbf{S}(\boldsymbol{\omega}) &amp;= \frac{\theta}{2 \Delta t \sin \theta} \left( R - R^{\top} \right)\end{split}\]</div>
<p>So now we have the following relationship where everything on the right side is known.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\boldsymbol{\beta}_a &amp;= \left(\textbf{A}^{\top}\textbf{A}\right)^{-1}\textbf{A}^{\top}\textbf{g}^r \\
\boldsymbol{\beta}_\omega &amp;= \left(\textbf{A}^{\top}\textbf{A}\right)^{-1}\textbf{A}^{\top}\boldsymbol{\omega}\end{split}\]</div>
<p>And from these equations we can convert the accelerometer and gyro data to units of acceleration and angular velocity, respectively</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="modules.html" class="btn btn-neutral float-right" title="estimator" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome to QuaternionUkf’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Matt Lisle

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>